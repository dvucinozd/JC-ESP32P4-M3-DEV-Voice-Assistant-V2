=====================================================================
HOME ASSISTANT INTEGRATION - ESP32-P4 Voice Assistant
=====================================================================

IMPLEMENTED FEATURES:
=====================

1. mDNS Client
   - Resolves kira.local hostname automatically
   - Falls back to IP address (192.168.0.134) if mDNS fails
   - Advertises device as "esp32-p4-voice-assistant.local"

2. WebSocket Client with HTTPS
   - Secure connection to wss://kira.local:8123/api/websocket
   - TLS/SSL encryption enabled
   - Certificate verification skipped for self-signed certs
   - Automatic reconnection on disconnect

3. Home Assistant Authentication
   - Uses long-lived access token from config.h
   - Automatic authentication on WebSocket connect
   - Validates auth_ok/auth_invalid responses

4. Conversation API Integration
   - Sends text to HA conversation/process endpoint
   - Receives responses from Home Assistant
   - Message ID tracking for request/response matching

=====================================================================
CONFIGURATION:
==============

Location: main/config.h

#define HA_HOSTNAME "kira.local"
#define HA_HOST "192.168.0.134"    // Fallback IP
#define HA_PORT 8123
#define HA_TOKEN "your-long-lived-access-token"
#define HA_USE_SSL true
#define HA_WEBSOCKET_PATH "/api/websocket"

=====================================================================
FILES CREATED:
==============

New files:
- main/ha_client.h         (Header for HA client API)
- main/ha_client.c         (WebSocket + mDNS implementation)
- HA_INTEGRATION.txt       (This file)

Modified files:
- main/config.h            (Added HA_HOSTNAME, HA_USE_SSL)
- main/CMakeLists.txt      (Added ha_client.c)
- main/mp3_player.c        (Added HA client initialization)
- sdkconfig.defaults       (Added mDNS, WebSocket, mbedTLS config)

=====================================================================
API USAGE:
==========

// Initialize (called automatically in app_main)
esp_err_t ha_client_init(void);

// Check connection status
bool ha_client_is_connected(void);

// Send text command
ha_client_send_text("Turn on living room lights");

// Start voice conversation (for future audio streaming)
char *conv_id = ha_client_start_conversation();

// Stream audio (not yet implemented)
ha_client_stream_audio(audio_data, length, conv_id);

// Stop client
ha_client_stop();

=====================================================================
EXPECTED OUTPUT AFTER BUILD & FLASH:
====================================

I (xxx) mp3_player: WiFi connected successfully!
I (xxx) mp3_player: Connecting to Home Assistant...
I (xxx) ha_client: Initializing Home Assistant client...
I (xxx) ha_client: mDNS initialized
I (xxx) ha_client: Resolving mDNS hostname: kira.local
I (xxx) ha_client: Resolved kira.local to 192.168.0.xxx
I (xxx) ha_client: Connecting to: wss://192.168.0.xxx:8123/api/websocket
I (xxx) ha_client: WebSocket client started, waiting for authentication...
I (xxx) ha_client: WebSocket connected to Home Assistant
I (xxx) ha_client: Sent authentication token
I (xxx) ha_client: WebSocket received data: {"type":"auth_ok",...}
I (xxx) ha_client: Home Assistant authentication successful!
I (xxx) ha_client: Home Assistant client initialized successfully
I (xxx) mp3_player: Home Assistant connected successfully!
I (xxx) ha_client: Sending to HA: {"id":1,"type":"conversation/process","text":"ESP32-P4 Voice Assistant is online!"}

=====================================================================
TROUBLESHOOTING:
================

1. mDNS resolution fails:
   - Check that kira.local is accessible on your network
   - Verify mDNS/Bonjour is enabled on router
   - System will automatically fall back to IP address

2. WebSocket connection timeout:
   - Verify Home Assistant is running on port 8123
   - Check firewall settings
   - Try disabling HTTPS temporarily (set HA_USE_SSL to false)

3. Authentication failed:
   - Verify HA_TOKEN in config.h is correct
   - Token must be "Long-Lived Access Token" from HA profile
   - Check token hasn't expired

4. TLS/SSL errors:
   - Current config skips certificate verification
   - This is OK for local network with self-signed certs
   - For production, add proper CA certificate

5. WebSocket data not received:
   - Check WS_BUFFER_SIZE in sdkconfig (default 4096)
   - Increase if receiving large JSON responses
   - Monitor heap memory usage

=====================================================================
HOME ASSISTANT SETUP:
=====================

1. Create Long-Lived Access Token:
   - Go to HA Profile (bottom left)
   - Scroll to "Long-Lived Access Tokens"
   - Click "Create Token"
   - Name: "ESP32-P4 Voice Assistant"
   - Copy token to config.h

2. Enable Voice Assistant:
   - Go to Settings → Voice Assistants
   - Configure Assist Pipeline
   - Set up STT (Speech-to-Text) provider
   - Set up TTS (Text-to-Speech) provider
   - Configure wake word (optional)

3. Network Configuration:
   - Ensure mDNS is enabled (usually automatic)
   - Configure firewall to allow port 8123
   - If using HTTPS, ensure certificate is valid

=====================================================================
NEXT DEVELOPMENT STEPS:
=======================

Phase 1: Audio Streaming (Current - Partially Complete)
✓ WiFi connectivity
✓ mDNS resolution
✓ WebSocket connection
✓ HA authentication
✓ Text conversation API
⏳ Binary audio streaming over WebSocket
⏳ WAV/PCM audio encoding

Phase 2: Voice Pipeline Integration
⏳ Assist Pipeline API integration
⏳ STT streaming (microphone → HA)
⏳ TTS playback (HA → speaker)
⏳ Intent handling

Phase 3: Wake Word Detection
⏳ Local wake word processing
⏳ TensorFlow Lite Micro integration
⏳ Voice Activity Detection (VAD)
⏳ Acoustic Echo Cancellation (AEC)

Phase 4: Advanced Features
⏳ Multiple pipeline support
⏳ Custom wake words
⏳ Voice feedback/beeps
⏳ LED indicators
⏳ Button override

=====================================================================
WEBSOCKET MESSAGE EXAMPLES:
===========================

Authentication:
--------------
→ {"type":"auth","access_token":"eyJhbG..."}
← {"type":"auth_ok","ha_version":"2024.11.0"}

Send Text Command:
-----------------
→ {"id":1,"type":"conversation/process","text":"Turn on lights"}
← {"id":1,"type":"result","success":true,"result":{...}}

Start Assist Pipeline:
---------------------
→ {"id":2,"type":"assist_pipeline/run","start_stage":"stt","end_stage":"tts"}
← {"id":2,"type":"result","success":true}

Stream Audio:
------------
→ Binary WebSocket frame with PCM audio data
← {"event":{"type":"stt-end","data":{"stt_output":{"text":"..."}}}}

=====================================================================
MEMORY USAGE:
=============

Component Memory Usage (approximate):
- WiFi Remote stack: ~40KB
- WebSocket client: ~12KB
- mDNS: ~8KB
- TLS/SSL buffers: ~16KB
- JSON parsing: ~4KB
- Total network stack: ~80KB

Available on ESP32-P4:
- 256KB internal RAM
- 32MB PSRAM @ 200MHz
- Plenty of memory for audio buffers!

=====================================================================
SECURITY NOTES:
===============

1. Access Token Storage:
   - Currently stored in config.h (plaintext)
   - For production: Use NVS encrypted storage
   - Rotate tokens regularly

2. TLS Certificate Verification:
   - Currently DISABLED for ease of setup
   - Enable for production deployments
   - Add CA certificate to cert_pem

3. Network Security:
   - Use WPA3 WiFi if available
   - Isolate IoT devices on separate VLAN
   - Use firewall rules to limit access

=====================================================================
DEBUGGING:
==========

Enable verbose logging:
- Set log level to VERBOSE in sdkconfig
- Monitor WebSocket traffic
- Check HA logs: Settings → System → Logs

Test WebSocket manually:
- Use wscat or Postman
- Connect to wss://kira.local:8123/api/websocket
- Send auth message manually

Check mDNS:
- Use avahi-browse (Linux) or dns-sd (Mac)
- Verify kira.local resolves correctly
- Check for mDNS conflicts

Monitor heap memory:
- esp_get_free_heap_size()
- esp_get_minimum_free_heap_size()
- Watch for memory leaks

=====================================================================
RESOURCES:
==========

Home Assistant WebSocket API:
https://developers.home-assistant.io/docs/api/websocket

Home Assistant Assist Pipeline:
https://www.home-assistant.io/voice_control/

ESP-IDF WebSocket Client:
https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/esp_websocket_client.html

ESP-IDF mDNS:
https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/mdns.html

=====================================================================
